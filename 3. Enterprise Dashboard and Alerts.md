# Windows Security Monitoring Manual - Wazuh & Kibana 9.1.3

## Manual Overview

This manual provides step-by-step instructions for creating Windows security dashboards and alerts using Wazuh and Kibana 9.1.3. All configurations are generic and will automatically work with any Windows machine that has a Wazuh agent installed.

**Base Filter for All Windows Monitoring:** `rule.groups.keyword: "windows"`

---

## Part 1: Dashboard Creation with Kibana 9.1.3

### Step 1: Access Dashboard Creation

1. Open Kibana web interface
2. Navigate to **Analytics** → **Dashboard**
3. Click **Create new dashboard**

### Step 2: Main Windows Security Dashboard

Create 6 panels using the following configurations:

#### Panel 1: Windows Threat Activity Timeline

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** Click **Add filter** → Field: `rule.groups.keyword` → Operator: `is` → Value: `windows` → Add another filter: Field: `rule.level` → Operator: `is greater than or equal` → Value: `7`
4. **From Available fields list on the left, drag `@timestamp` to the workspace**
5. **The editor will automatically create a bar chart over time**
6. **To change to line chart:** Click **Visualization type** dropdown → Select **Line**
7. **Add series breakdown:** From Available fields, drag `rule.level` to the workspace
8. **Configure in layer pane:**
   - **Horizontal axis:** @timestamp (should be automatically set)
   - **Vertical axis:** Count of records (should be automatically set)
   - **Break down by:** rule.level (from drag operation)
9. **Title:** Windows Threat Activity Timeline
10. Click **Save and return**

#### Panel 2: Critical Security Events Counter

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** `rule.groups.keyword: "windows" AND rule.level: >= 12`
4. **Open Visualization type dropdown → Select Metric**
5. **From Available fields, drag any field to workspace** (Lens will auto-detect Count)
6. **In layer pane:** Should show "Count of records"
7. **Title:** Critical Security Events
8. Click **Save and return**

#### Panel 3: Windows Agent Distribution

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** `rule.groups.keyword: "windows"`
4. **From Available fields, drag `agent.name.keyword` to the workspace**
5. **Lens automatically creates a bar chart**
6. **To change to pie chart:** Click **Visualization type** dropdown → Select **Pie**
7. **In layer pane:**
   - **Slice by:** Top 10 values of agent.name.keyword
   - **Size by:** Count of records
8. **Title:** Windows Agent Distribution
9. Click **Save and return**

#### Panel 4: Top Security Alerts

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** `rule.groups.keyword: "windows"`
4. **From Available fields, drag `rule.description.keyword` to the workspace**
5. **Lens creates a horizontal bar chart automatically**
6. **In layer pane:**
   - **Breakdown:** Top 10 values of rule.description.keyword
   - **Metric:** Count of records
7. **Title:** Top Security Alerts
8. Click **Save and return**

#### Panel 5: Security Level Distribution

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** `rule.groups.keyword: "windows"`
4. **From Available fields, drag `rule.level` to the workspace**
5. **Lens creates a bar chart**
6. **To make vertical bar:** Click **Visualization type** dropdown → Select **Bar vertical**
7. **In layer pane:**
   - **Horizontal axis:** rule.level
   - **Vertical axis:** Count of records
8. **Title:** Security Level Distribution
9. Click **Save and return**

#### Panel 6: Recent Security Events Table

**Configuration Steps:**
1. Click **Create visualization**
2. Make sure **wazuh-alerts-*** data view is selected
3. **Add filter:** `rule.groups.keyword: "windows" AND rule.level: >= 8`
4. **Click Visualization type dropdown → Select Table**
5. **From Available fields, drag the following fields to the workspace one by one:**
   - `agent.name.keyword`
   - `rule.level`
   - `rule.description.keyword`
   - `@timestamp`
6. **In layer pane, each field will appear as "Top values of [field]"**
7. **To show recent events:** Click on "Top values of @timestamp" → Change **Order by** to **Alphabetical** and **Order** to **Descending**
8. **Title:** Recent Security Events
9. Click **Save and return**

### Step 3: Save Main Dashboard

1. Click **Save** in the top menu
2. **Title:** Windows Security Overview
3. **Description:** Main dashboard for Windows security monitoring
4. Click **Save**

---

## Part 2: Specialized Monitoring Dashboards

### PowerShell Activity Dashboard

#### PowerShell Execution Monitoring

**Steps:**
1. Create new dashboard: **PowerShell Security Monitoring**
2. Click **Create visualization**
3. **Add filter:** `rule.groups.keyword: "windows" AND data.win.eventdata.image.keyword: "*powershell*"`
4. **From Available fields, drag `@timestamp` to workspace**
5. **Lens creates time series automatically**
6. **Change to line chart** if needed
7. **Title:** PowerShell Execution Timeline

#### Encoded PowerShell Detection

**Steps:**
1. Click **Create visualization**
2. **Add filter:** `rule.groups.keyword: "windows" AND data.win.eventdata.commandLine.keyword: "*-enc*"`
3. **Click Visualization type → Select Table**
4. **From Available fields, drag:**
   - `@timestamp`
   - `agent.name.keyword`
   - `data.win.eventdata.commandLine.keyword`
   - `data.win.eventdata.user.keyword`
5. **Title:** Encoded PowerShell Commands

### Lateral Movement Dashboard

#### Administrative Tool Usage

**Filter:** `rule.groups.keyword: "windows" AND data.win.eventdata.image.keyword: ("*wmic.exe" OR "*sc.exe" OR "*schtasks.exe")`

**Steps:**
1. Create visualization with above filter
2. Use bar chart showing tool usage over time

#### RDP Activity Monitoring

**Filter:** `rule.groups.keyword: "windows" AND rule.id: "4624" AND data.win.eventdata.logonType.keyword: "10"`

---

## Part 3: Alert Configuration

### Step 1: Access Alerting

1. Navigate to **Stack Management**
2. Click **Rules and Connectors**
3. Click **Rules**
4. Click **Create rule**

### Step 2: Critical PowerShell Alert

**Configuration Steps:**
1. **Name:** Critical PowerShell Activity
2. **Rule type:** Index threshold
3. **Index:** wazuh-alerts-*
4. **Time field:** @timestamp
5. **Define the condition:**
   - **WHEN count()**
   - **IS ABOVE 10**
   - **FOR THE LAST 5 minutes**
6. **Add filter query (KQL):**
   ```
   rule.groups.keyword: "windows" AND data.win.eventdata.image.keyword: "*powershell*" AND rule.level: >= 7
   ```
7. **Check every:** 1 minute
8. **Notify:** Configure email or other connector
9. Click **Save**

### Step 3: Lateral Movement Alert

**Configuration Steps:**
1. **Name:** Windows Lateral Movement Detection
2. **Rule type:** Index threshold
3. **Index:** wazuh-alerts-*
4. **Time field:** @timestamp
5. **Define the condition:**
   - **WHEN count()**
   - **IS ABOVE 5**
   - **FOR THE LAST 10 minutes**
6. **Add filter query (KQL):**
   ```
   rule.groups.keyword: "windows" AND data.win.eventdata.image.keyword: (*wmic.exe OR *sc.exe OR *schtasks.exe)
   ```
7. **Check every:** 2 minutes
8. Click **Save**

### Step 4: File Integrity Alert

**Configuration Steps:**
1. **Name:** Critical System File Changes
2. **Rule type:** Index threshold
3. **Index:** wazuh-alerts-*
4. **Time field:** @timestamp
5. **Define the condition:**
   - **WHEN count()**
   - **IS ABOVE OR EQUAL 1**
   - **FOR THE LAST 1 minute**
6. **Add filter query (KQL):**
   ```
   rule.groups.keyword: "syscheck" AND syscheck.path.keyword: "C:\\Windows\\System32\\*" AND rule.level: >= 10
   ```
7. **Check every:** 30 seconds
8. Click **Save**

### Step 5: Registry Persistence Alert

**Configuration Steps:**
1. **Name:** Windows Registry Persistence
2. **Rule type:** Index threshold
3. **Index:** wazuh-alerts-*
4. **Time field:** @timestamp
5. **Define the condition:**
   - **WHEN count()**
   - **IS ABOVE OR EQUAL 1**
   - **FOR THE LAST 5 minutes**
6. **Add filter query (KQL):**
   ```
   rule.groups.keyword: "syscheck" AND syscheck.path.keyword: "*CurrentVersion\\Run*"
   ```
7. **Check every:** 1 minute
8. Click **Save**

### Step 6: RDP Brute Force Alert

**Configuration Steps:**
1. **Name:** RDP Brute Force Detection
2. **Rule type:** Index threshold
3. **Index:** wazuh-alerts-*
4. **Time field:** @timestamp
5. **Define the condition:**
   - **WHEN count()**
   - **IS ABOVE 15**
   - **FOR THE LAST 15 minutes**
6. **Add filter query (KQL):**
   ```
   rule.groups.keyword: "windows" AND rule.id: "4625" AND data.win.eventdata.logonType.keyword: "10"
   ```
7. **Check every:** 2 minutes
8. Click **Save**

---

## Part 4: Custom Wazuh Rules

### Step 1: Access Wazuh Manager

1. SSH into Wazuh manager server
2. Navigate to: `/var/ossec/etc/rules/`
3. Create file: `local_rules.xml`

### Step 2: PowerShell Detection Rules

Add to `/var/ossec/etc/rules/local_rules.xml`:

```xml
<group name="powershell,windows,">
  <rule id="100001" level="12">
    <if_group>windows</if_group>
    <field name="data.win.eventdata.image">powershell.exe</field>
    <field name="data.win.eventdata.commandLine">-enc</field>
    <description>PowerShell encoded command execution detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>

  <rule id="100002" level="10">
    <if_group>windows</if_group>
    <field name="data.win.eventdata.image">powershell.exe</field>
    <regex>Invoke-Expression|IEX|DownloadString</regex>
    <description>Suspicious PowerShell command execution detected</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
  </rule>
</group>
```

### Step 3: Apply Rules

1. Test rules: `/var/ossec/bin/wazuh-logtest`
2. Restart Wazuh manager: `systemctl restart wazuh-manager`

---

## Part 5: Common Filters for Different Use Cases

### Master Filters

**All Windows Events:**
```
rule.groups.keyword: "windows"
```

**High Severity Windows Events:**
```
rule.groups.keyword: "windows" AND rule.level: >= 10
```

**PowerShell Activity:**
```
rule.groups.keyword: "windows" AND data.win.eventdata.image.keyword: "*powershell*"
```

**File Changes:**
```
rule.groups.keyword: "syscheck" AND syscheck.path.keyword: "C:\\*"
```

**Authentication Events:**
```
rule.groups.keyword: "windows" AND (rule.id: "4624" OR rule.id: "4625")
```

---

## Part 6: Troubleshooting

### Common Issues

#### No Data Appearing

**Check:**
1. Data view exists: `wazuh-alerts-*`
2. Time range includes recent data
3. Filters use `.keyword` fields
4. Windows agents are active

#### Visualizations Not Working

**Check:**
1. Use `rule.groups.keyword: "windows"` not `rule.groups`
2. Field names match exactly
3. Time range is appropriate
4. Data exists in the selected timeframe

### Field Reference

**Essential Fields:**
- `rule.groups.keyword` - Rule categories (use "windows")
- `agent.name.keyword` - Agent hostname
- `rule.level` - Severity (1-16)
- `rule.description.keyword` - Alert description
- `data.win.eventdata.image.keyword` - Process executable
- `data.win.eventdata.commandLine.keyword` - Command line
- `data.win.eventdata.user.keyword` - User account
- `syscheck.path.keyword` - File paths
- `@timestamp` - Event timestamp

---

## Implementation Checklist

### Dashboard Creation
- [ ] Create Windows Security Overview dashboard
- [ ] Add 6 visualization panels using drag-and-drop
- [ ] Create specialized PowerShell dashboard
- [ ] Create lateral movement dashboard
- [ ] Test all visualizations display data correctly

### Alert Configuration
- [ ] Configure 6 critical Windows alerts
- [ ] Test alert conditions trigger properly
- [ ] Set up notification channels
- [ ] Verify email delivery works

### Wazuh Rules
- [ ] Add custom PowerShell detection rules
- [ ] Test rules with wazuh-logtest
- [ ] Restart Wazuh manager
- [ ] Confirm new rules generate alerts

This manual provides exact steps for Kibana 9.1.3's current drag-and-drop interface. All configurations are generic and will automatically work with any number of Windows machines.
