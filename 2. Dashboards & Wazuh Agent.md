# Kibana Dashboards & Windows Agent Integration Guide

> **Complete guide for creating security dashboards, installing Wazuh agents, & implementing advanced monitoring with Kibana 9.1.2**

---

## Table of Contents

1. [Creating Modern Security Dashboards](#part-1-creating-modern-security-dashboards)
2. [Windows Agent Installation](#part-2-windows-agent-installation)
3. [Windows-Specific Monitoring](#part-3-windows-specific-monitoring)
4. [Advanced Kibana Features](#part-4-advanced-kibana-features)
5. [Suricata Log Enhancement](#part-5-suricata-log-enhancement)
6. [Dashboard Templates](#part-6-dashboard-templates)

---

## Part 1: Creating Modern Security Dashboards

### Prerequisites

Before creating dashboards, ensure you have:

-  Kibana 9.1.2 running and accessible
-  Wazuh alerts flowing into Elasticsearch
-  Proper data views configured
-  Administrative access to Kibana

### Step 1.1: Access Dashboard Creation

| Action | Navigation Path |
|--------|----------------|
| **Open Dashboards** | Analytics → Dashboard |
| **Create New** | Click "Create dashboard" |
| **Access Dev Tools** | Management → Dev Tools (for advanced queries) |

### Step 1.2: Security Overview Dashboard Components

Create a comprehensive security dashboard with these core visualizations:

#### Visualization 1: Alert Severity Distribution (Donut Chart)

**Configuration:**
- **Visualization Type**: Donut Chart
- **Metric**: Count of documents
- **Bucket Aggregation**: Terms on `rule.level` (Wazuh) or `service.type` (Suricata)
- **Purpose**: Shows distribution of alert severity levels

#### Visualization 2: Top Attacked Services (Horizontal Bar Chart)

**Configuration:**
- **Visualization Type**: Horizontal Bar
- **Data Source Options**:
  - For Suricata: Terms aggregation on `host.ip`
  - For Wazuh: Terms aggregation on `agent.name`
- **Purpose**: Identifies most targeted systems

#### Visualization 3: Security Events Timeline (Line Chart)

**Configuration:**
- **Visualization Type**: Line Chart
- **X-axis**: Date histogram on `@timestamp`
- **Y-axis**: Count of events
- **Series Split**: By `service.type` or `rule.groups`
- **Purpose**: Shows event trends over time

#### Visualization 4: Geographic Threat Distribution (Map)

**Configuration:**
- **Visualization Type**: Maps
- **Layer Type**: Clusters on `source.geo.location`
- **Purpose**: Displays geographic distribution of threats

> **Note**: Requires GeoIP data to be configured in your pipeline

### Step 1.3: Create Saved Searches for Quick Access

Navigate to **Discover** and create these saved searches:

#### High Severity Wazuh Alerts
```kql
rule.level >= 10
```

#### Suricata IDS Alerts
```kql
service.type: "system" AND message: *alert*
```

#### Failed Authentication Attempts
```kql
tags: "authentication_failed" OR message: *"failed password"*
```

**To save searches:**
1. Apply the KQL query in Discover
2. Click "Save" in the top menu
3. Provide descriptive names for easy reference

---

## Part 2: Windows Agent Installation

### Step 2.1: Prepare Windows Host

Ensure the following requirements are met:

| Requirement | Specification |
|-------------|---------------|
| **Operating System** | Windows 10/11, Windows Server 2016+ |
| **Architecture** | x64 (64-bit) |
| **Network Access** | Connectivity to Wazuh Manager on ports 1514, 1515 |
| **Privileges** | Administrator rights for installation |

### Step 2.2: Download and Install Wazuh Agent

#### Method 1: PowerShell Installation (Recommended)

Open PowerShell as Administrator and execute:

```powershell
# Download the latest Wazuh Agent
Invoke-WebRequest -Uri "https://packages.wazuh.com/4.x/windows/wazuh-agent-4.9.2-1.msi" -OutFile "wazuh-agent.msi"

# Install with manager configuration
# Replace YOUR_MANAGER_IP with your Debian server IP address
msiexec.exe /i wazuh-agent.msi /q WAZUH_MANAGER="YOUR_MANAGER_IP" WAZUH_REGISTRATION_SERVER="YOUR_MANAGER_IP"
```

#### Method 2: GUI Installation

1. **Download**: Visit the Wazuh downloads page or use the PowerShell command above
2. **Run Installer**: Execute the MSI file as Administrator
3. **Configure Manager**: 
   - Enter Manager IP: Your Debian server IP address
   - Agent Name: Choose a descriptive name (e.g., "Windows-Workstation-01")
4. **Complete Installation**: Follow the installation wizard

### Step 2.3: Verify Agent Registration

On your Wazuh Manager (Debian server), verify the agent registration:

#### List All Registered Agents
```bash
sudo /var/ossec/bin/manage_agents -l
```

#### Check Agent Connection Status
```bash
sudo /var/ossec/bin/agent_control -lc
```

**Expected Output Example:**
```
Wazuh agent_control. List of available agents:
   ID: 001, Name: Windows-Workstation-01, IP: 192.168.1.100, Active
```

#### Apply Configuration Changes
```bash
sudo systemctl restart wazuh-manager
```

### Step 2.4: Verify Data Flow

1. **Check Kibana**: Navigate to Discover and look for events from the new agent
2. **Filter by Agent**: Use `agent.name: "your-windows-host"` in KQL
3. **Verify Timestamps**: Ensure events are recent and flowing

---

## Part 3: Windows-Specific Monitoring

### Step 3.1: Create Windows Security Dashboard

#### Dashboard Layout Strategy

Create a dedicated Windows monitoring dashboard with these components:

| Visualization | Purpose | KQL Filter |
|---------------|---------|------------|
| **Windows Security Events** | Monitor security-related events | `agent.name: "your-windows-host" AND rule.groups: "windows"` |
| **Process Monitoring** | Track process creation/termination | `data.win.eventdata.processName: * AND agent.os.platform: "windows"` |
| **Registry Changes** | Monitor registry modifications | `rule.groups: "syscheck" AND agent.os.platform: "windows" AND syscheck.path: *registry*` |

### Step 3.2: Windows Security Events Visualization

**Configuration Steps:**
1. Create new visualization in Dashboard
2. Select **Lens** as visualization type
3. **Data Source**: wazuh-alerts-*
4. **Filter**: `agent.name: "your-windows-host" AND rule.groups: "windows"`
5. **Visualization**: Time series or data table

### Step 3.3: Process Monitoring Setup

Create a visualization to monitor Windows processes:

**KQL Query:**
```kql
data.win.eventdata.processName: * AND agent.os.platform: "windows"
```

**Suggested Visualization**: 
- **Type**: Data table
- **Columns**: Process Name, Command Line, User, Timestamp
- **Time Range**: Last 24 hours

### Step 3.4: File Integrity Monitoring

Monitor critical file and registry changes:

**KQL Query:**
```kql
rule.groups: "syscheck" AND agent.os.platform: "windows" AND syscheck.path: *registry*
```

**Visualization Options**:
- Heat map for file change frequency
- Data table for detailed change logs
- Timeline for change patterns

---

## Part 4: Advanced Kibana Features

### Step 4.1: Using Lens for Enhanced Visualizations

#### Accessing Lens
1. Navigate to **Analytics → Visualize Library**
2. Click **Create visualization**
3. Select **Lens**

#### Lens Advantages

| Feature | Benefit |
|---------|---------|
| **Drag and Drop Interface** | Intuitive visualization creation |
| **Real-time Preview** | Immediate feedback on changes |
| **Formula Support** | Complex calculations made easy |
| **Automatic Suggestions** | Smart field recommendations |

#### Creating Visualizations with Lens
1. **Select Data View**: Choose your wazuh-alerts-* data view
2. **Drag Fields**: Drag fields to appropriate areas (X-axis, Y-axis, etc.)
3. **Configure Options**: Adjust colors, labels, and formatting
4. **Save**: Give your visualization a descriptive name

### Step 4.2: Setting Up Automated Alerts

#### Navigate to Alert Creation
**Path**: Stack Management → Rules and Connectors → Rules

#### Create High Severity Alert Rule

```json
{
  "consumer": "alerts",
  "name": "High Severity Security Alert",
  "rule_type_id": ".index-threshold",
  "params": {
    "index": ["wazuh-alerts-*"],
    "timeField": "@timestamp",
    "aggType": "count",
    "thresholdComparator": ">",
    "threshold": [10],
    "timeWindowSize": 5,
    "timeWindowUnit": "m",
    "filterQuery": {
      "match": {
        "rule.level": {
          "query": "12",
          "operator": "and"
        }
      }
    }
  }
}
```

#### Alert Configuration Parameters

| Parameter | Description | Example Value |
|-----------|-------------|---------------|
| **Index Pattern** | Target indices to monitor | `wazuh-alerts-*` |
| **Time Field** | Field used for time-based queries | `@timestamp` |
| **Threshold** | Alert trigger condition | `> 10 events in 5 minutes` |
| **Filter Query** | Additional conditions | `rule.level >= 12` |

### Step 4.3: Professional SIEM-Style Dashboard Layout

#### Recommended Dashboard Structure

```
Dashboard Layout (4x3 Grid):
┌─────────────────────────────────┬──────────────────┐
│ Alert Trend (Line Chart)        │ Severity Dist    │
│ Shows 24-hour event timeline    │ (Donut Chart)    │
├─────────────────────────────────┼──────────────────┤
│ Top 10 Alerts (Data Table)      │ Top Agents       │
│ Most frequent alert types       │ (Horizontal Bar) │
├─────────────────────────────────┼──────────────────┤
│ Recent Critical Alerts (Saved Search)             │
│ Real-time feed of high-priority events            │
└────────────────────────────────────────────────────┘
```

#### Dashboard Best Practices

| Practice | Rationale |
|----------|-----------|
| **Consistent Time Ranges** | Ensures data correlation |
| **Color Coding** | Red for critical, yellow for warning, green for info |
| **Responsive Design** | Works on different screen sizes |
| **Filter Integration** | Dashboard-wide filters for focused analysis |

### Step 4.4: Runtime Fields for Custom Metrics

#### Creating Risk Score Field

Add this runtime field in your Data View settings:

```json
{
  "risk_score": {
    "type": "long",
    "script": {
      "source": """
        if (doc.containsKey('rule.level')) {
          emit(doc['rule.level'].value * 10);
        }
      """
    }
  }
}
```

#### Runtime Field Benefits

- **No Re-indexing Required**: Fields are calculated at query time
- **Flexible Calculations**: Support for complex scripts
- **Resource Efficient**: Only computed when needed

---

## Part 5: Suricata Log Enhancement

### Step 5.1: Improve Suricata Log Parsing

Since Suricata logs are coming through syslog, enhance the Logstash parsing:

#### Enhanced Logstash Filter Configuration

Add this filter to your Logstash pipeline:

```ruby
filter {
  if [service.type] == "system" and [message] =~ /suricata/ {
    # Parse syslog structure
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:device} %{PROG:program}: %{GREEDYDATA:suricata_message}" 
      }
    }
    
    # Extract network connection details
    grok {
      match => { 
        "suricata_message" => "%{IP:src_ip}:%{INT:src_port} -> %{IP:dst_ip}:%{INT:dst_port}"
      }
      tag_on_failure => ["_grokparsefailure_suricata_connection"]
    }
    
    # Parse alert severity if present
    grok {
      match => {
        "suricata_message" => "Priority: %{INT:alert_priority}"
      }
      tag_on_failure => []
    }
    
    # Add parsed fields
    mutate {
      add_field => { "log_source" => "suricata" }
      add_tag => [ "suricata_parsed" ]
    }
  }
}
```

### Step 5.2: Create Suricata-Specific Visualizations

#### Network Traffic Analysis
**KQL Query:**
```kql
log_source: "suricata" AND src_ip: * AND dst_ip: *
```

#### Alert Priority Distribution
**KQL Query:**
```kql
log_source: "suricata" AND alert_priority: *
```

---

## Part 6: Dashboard Templates

### Step 6.1: Security Operations Dashboard Template

#### Quick Import Instructions

1. **Navigate**: Stack Management → Saved Objects
2. **Import**: Click "Import" button
3. **Upload**: Use the JSON template below

#### Dashboard Template (NDJSON Format)

```json
{"attributes":{"title":"Security Operations Dashboard","type":"dashboard","description":"Unified Wazuh and Suricata monitoring for comprehensive security oversight"},"references":[],"coreMigrationVersion":"9.1.2","version":"WzEsM10="}
{"attributes":{"title":"Alert Severity Timeline","type":"visualization","description":"Timeline visualization showing alert distribution over time","visState":"{\"type\":\"line\",\"params\":{\"grid\":{\"categoryLines\":false,\"style\":{\"color\":\"#eee\"}},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"truncate\":100},\"title\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":false,\"truncate\":100},\"title\":{\"text\":\"Count\"}}]},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"schema\":\"segment\",\"params\":{\"field\":\"@timestamp\",\"interval\":\"auto\",\"customInterval\":\"2h\",\"min_doc_count\":1,\"extended_bounds\":{}}}]}","uiStateJSON":"{}","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"index\":\"wazuh-alerts-*\",\"query\":{\"match_all\":{}},\"filter\":[]}"}},"references":[{"name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern","id":"wazuh-alerts-*"}],"coreMigrationVersion":"9.1.2","version":"WzIsM10="}
```

### Step 6.2: Custom Dashboard Components

#### Create Reusable Components

| Component Type | Use Case | Configuration |
|----------------|----------|---------------|
| **Metric Visualizations** | KPI displays | Single number with trend indicators |
| **Data Tables** | Detailed event listings | Sortable columns with filtering |
| **Heat Maps** | Pattern identification | Time vs. category analysis |
| **Geographic Maps** | Location-based analysis | IP geolocation plotting |

---

## Verification and Testing

### Step 1: Verify Data Flow

| Check | Command/Action | Expected Result |
|-------|---------------|-----------------|
| **Agent Registration** | `sudo /var/ossec/bin/manage_agents -l` | Agent listed as registered |
| **Agent Connectivity** | `sudo /var/ossec/bin/agent_control -lc` | Agent shows as "Active" |
| **Data in Kibana** | Filter by agent name in Discover | Events from Windows agent visible |
| **Dashboard Functionality** | Open created dashboards | Visualizations populate with data |

### Step 2: Performance Validation

- **Dashboard Load Time**: Should be under 5 seconds
- **Query Response**: Real-time updates without delays
- **Resource Usage**: Monitor Elasticsearch cluster health

### Step 3: Alert Testing

1. **Generate Test Events**: Create controlled security events on Windows
2. **Verify Alerts**: Check if Kibana alerts trigger properly
3. **Dashboard Updates**: Confirm visualizations reflect new data

---

## Troubleshooting Guide

### Common Issues and Solutions

| Issue | Symptoms | Solution |
|-------|----------|----------|
| **No Windows Events** | Empty dashboards, no agent data | Verify agent connectivity and configuration |
| **Dashboard Load Errors** | Visualizations fail to load | Check data view configuration and field mappings |
| **Slow Performance** | Dashboards take long to load | Optimize queries and reduce time ranges |
| **Missing Geo Data** | Maps show no location data | Configure GeoIP processor in Elasticsearch |

### Log Locations for Debugging

| Component | Log Path | Purpose |
|-----------|----------|---------|
| **Windows Agent** | `C:\Program Files (x86)\ossec-agent\logs\ossec.log` | Agent operation logs |
| **Kibana** | `/var/log/kibana/kibana.log` | Dashboard and visualization errors |
| **Elasticsearch** | `/var/log/elasticsearch/*.log` | Query and indexing issues |

---

## Best Practices Summary

### Dashboard Design
- **Keep it Simple**: Focus on essential metrics
- **Use Consistent Colors**: Maintain visual coherence
- **Optimize Query Performance**: Use appropriate time ranges
- **Regular Updates**: Keep dashboards current with threat landscape

### Security Monitoring
- **Multiple Data Sources**: Combine Wazuh and Suricata for comprehensive coverage
- **Alert Tuning**: Regularly adjust thresholds to reduce false positives
- **Documentation**: Maintain runbooks for incident response

### Maintenance
- **Regular Backups**: Export dashboard configurations
- **Performance Monitoring**: Track dashboard load times
- **User Training**: Ensure team members understand dashboard usage

---

## Next Steps

After completing this guide, consider these advanced topics:

-  **Machine Learning Integration**: Set up anomaly detection
-  **Advanced Alerting**: Configure email/Slack notifications
-  **Custom Threat Intel**: Integrate external threat feeds
-  **Automated Response**: Set up SOAR integration
-  **Compliance Reporting**: Create regulatory compliance dashboards

---

## Additional Resources

### Documentation Links
- [Kibana Dashboard Documentation](https://www.elastic.co/guide/en/kibana/current/dashboard.html)
- [Wazuh Agent Installation Guide](https://documentation.wazuh.com/current/installation-guide/wazuh-agent/)
- [KQL Query Language Reference](https://www.elastic.co/guide/en/kibana/current/kuery-query.html)

### Community Resources
- [Wazuh Community Forum](https://wazuh.com/community/)
- [Elastic Community Forum](https://discuss.elastic.co/)
- [Security Dashboard Templates](https://github.com/elastic/examples)

---

> **Success!** You now have comprehensive security monitoring with professional dashboards, Windows agent integration, and advanced Kibana features for effective threat detection and analysis.
